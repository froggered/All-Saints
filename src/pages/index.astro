---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import ServiceTimes from '../components/ServiceTimes.astro';
import LocationCard from '../components/LocationCard.astro';
import EventCard from '../components/EventCard.astro';
import { getCollection } from 'astro:content';
import { getServices, getSettings } from '../lib/content';

// Get services from YAML
const services = getServices();

// Get settings
const settings = getSettings();

// Get upcoming events
const now = new Date();
const eventEntries = await getCollection('events');
const upcomingEvents = eventEntries
  .filter(e => e.data.date >= now)
  .sort((a, b) => a.data.date.getTime() - b.data.date.getTime())
  .slice(0, 3)
  .map(event => {
    const date = event.data.date;
    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return {
      month: months[date.getMonth()],
      day: String(date.getDate()).padStart(2, '0'),
      weekday: weekdays[date.getDay()],
      title: event.data.title,
      time: event.data.time,
      description: event.data.description,
      featured: event.data.featured,
    };
  });

// Get recent news
const newsEntries = await getCollection('news');
const recentNews = newsEntries
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 4)
  .map(post => ({
    title: post.data.title,
    date: post.data.date.toLocaleDateString('en-GB', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }),
    excerpt: post.data.excerpt,
    featured: post.data.featured,
  }));

// Featured news for the big card
const featuredNews = recentNews.find(n => n.featured) || recentNews[0];
---

<BaseLayout title="Home">
  <!-- Hero Section -->
  <Hero
    title="All Saints of Lincolnshire"
    subtitle="Orthodox Christian Parish · Antiochian Archdiocese"
    description="A congregation devoted to mission and evangelism in the heart of Lincoln. We welcome all who seek to discover the ancient faith of Orthodox Christianity."
    primaryCta={{ text: 'Plan Your Visit', href: '/All-Saints/discover/visit' }}
    secondaryCta={{ text: 'Watch Live', href: settings?.youtube || 'https://www.youtube.com/@ArchimandritePhilip' }}
  />

  <!-- Service Times & Location Section -->
  <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-6">
      <div class="section-header">
        <h2>Join Us for Worship</h2>
        <div class="section-divider"></div>
        <p class="text-slate max-w-xl mx-auto">
          Experience the beauty of Orthodox Christian worship. All are welcome.
        </p>
      </div>

      <div class="grid md:grid-cols-2 gap-8">
        <ServiceTimes services={services} />
        <LocationCard />
      </div>
    </div>
  </section>

  <!-- Upcoming Events Section -->
  <section class="py-20 bg-off-white">
    <div class="max-w-7xl mx-auto px-6">
      <div class="section-header">
        <h2>Upcoming Events</h2>
        <div class="section-divider"></div>
        <p class="text-slate max-w-xl mx-auto">
          Special services, feast days, and community gatherings
        </p>
      </div>

      {upcomingEvents.length > 0 ? (
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {upcomingEvents.map((event) => (
            <EventCard {...event} />
          ))}
        </div>
      ) : (
        <p class="text-center text-slate">No upcoming events at this time.</p>
      )}
    </div>
  </section>

  <!-- Welcome Section -->
  <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-6">
      <div class="grid lg:grid-cols-2 gap-16 items-center">
        <div>
          <h2 class="text-4xl text-navy mb-6">New to Orthodoxy?</h2>
          <p class="text-charcoal mb-4 text-lg">
            Orthodox Christianity is the ancient faith passed down from the Apostles,
            preserved unchanged for two thousand years. At All Saints, we welcome seekers
            from all backgrounds — whether you've never been to church or are exploring
            Orthodoxy after years in another tradition.
          </p>
          <p class="text-charcoal mb-8">
            Our community is devoted to mission and evangelism. We offer catechumen classes,
            Bible studies, and a warm welcome to all who wish to discover the fullness of
            the Christian faith.
          </p>
          <div class="flex flex-wrap gap-4">
            <a href="/All-Saints/discover" class="btn btn-primary">Discover Orthodoxy</a>
            <a href="/All-Saints/discover/visit" class="btn btn-secondary">What to Expect</a>
          </div>
        </div>

        <div class="relative">
          <div class="grid grid-cols-2 gap-4">
            <img
              src="/All-Saints/images/church_exterior.jpg"
              alt="Saint Matthias Church Centre exterior"
              class="w-full rounded-xl aspect-[3/4] object-cover shadow-lg"
            />
            <img
              src="/All-Saints/images/allsaints_icon.jpg"
              alt="All Saints Orthodox Icon"
              class="w-full rounded-xl aspect-[3/4] object-cover shadow-lg"
            />
          </div>
          <div class="absolute -bottom-6 -right-6 bg-gold text-navy p-6 rounded-lg shadow-xl max-w-xs">
            <blockquote class="font-accent italic text-lg mb-2">"Come and see"</blockquote>
            <cite class="font-heading text-sm uppercase tracking-wide">— John 1:46</cite>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- News Section -->
  <section class="py-20 bg-navy text-white">
    <div class="max-w-7xl mx-auto px-6">
      <div class="section-header">
        <h2 class="text-white">News & Updates</h2>
        <div class="section-divider"></div>
        <p class="text-white/70 max-w-xl mx-auto">
          The latest from All Saints of Lincolnshire
        </p>
      </div>

      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Featured Newsletter -->
        {featuredNews && (
          <div class="lg:col-span-2 bg-white/5 border border-white/10 rounded-xl p-8">
            <span class="font-heading text-xs uppercase tracking-widest text-gold mb-3 block">
              {featuredNews.featured ? 'Newsletter' : 'News'} · {featuredNews.date}
            </span>
            <h3 class="text-2xl font-heading uppercase tracking-wide mb-4">
              {featuredNews.title}
            </h3>
            <p class="text-white/80 mb-6">
              {featuredNews.excerpt}
            </p>
            <a href="/All-Saints/news" class="btn btn-secondary border-white text-white hover:bg-white/10">
              Read Full Newsletter
            </a>
          </div>
        )}

        <!-- Recent Posts -->
        <div>
          <h4 class="font-heading text-sm uppercase tracking-wide text-gold mb-6">Recent Posts</h4>
          <div class="space-y-4">
            {recentNews.slice(0, 4).map((post) => (
              <div class="pb-4 border-b border-white/10 last:border-0">
                <h5 class="font-heading text-sm uppercase tracking-wide mb-1">{post.title}</h5>
                <span class="text-xs text-white/50">{post.date}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
