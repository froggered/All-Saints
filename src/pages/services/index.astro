---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageHeader from '../../components/PageHeader.astro';
import ServiceTimes from '../../components/ServiceTimes.astro';
import EventCard from '../../components/EventCard.astro';
import { getCollection } from 'astro:content';
import { getServices } from '../../lib/content';

// Get services from YAML
const services = getServices();

// Get events from content collection, filter for future events
const now = new Date();
const eventEntries = await getCollection('events');
const upcomingEvents = eventEntries
  .filter(e => e.data.date >= now)
  .sort((a, b) => a.data.date.getTime() - b.data.date.getTime())
  .slice(0, 6)
  .map(event => {
    const date = event.data.date;
    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return {
      month: months[date.getMonth()],
      day: String(date.getDate()).padStart(2, '0'),
      weekday: weekdays[date.getDay()],
      title: event.data.title,
      time: event.data.time,
      description: event.data.description,
      featured: event.data.featured,
    };
  });
---

<BaseLayout title="Services & Calendar">
  <PageHeader
    title="Services & Calendar"
    subtitle="Join us for Orthodox Christian worship throughout the week"
  />

  <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-6">
      <div class="grid lg:grid-cols-3 gap-12">
        <!-- Service Times -->
        <div class="lg:col-span-1">
          <ServiceTimes services={services} />

          <div class="mt-8 p-6 bg-off-white rounded-xl">
            <h3 class="font-heading text-lg uppercase tracking-wide text-navy mb-4">
              About Our Services
            </h3>
            <p class="text-slate text-sm mb-4">
              The Divine Liturgy is the central worship service of the Orthodox Church,
              celebrated on Saturdays and Sundays. Vespers is the evening prayer service
              that begins the liturgical day.
            </p>
            <p class="text-slate text-sm">
              All are welcome to attend. If this is your first visit, please see our
              <a href="/All-Saints/discover/visit" class="text-gold hover:underline">guide for visitors</a>.
            </p>
          </div>
        </div>

        <!-- Calendar -->
        <div class="lg:col-span-2" id="calendar">
          <h2 class="text-3xl text-navy mb-8">Upcoming Events</h2>

          {upcomingEvents.length > 0 ? (
            <div class="grid sm:grid-cols-2 gap-6">
              {upcomingEvents.map((event) => (
                <EventCard {...event} />
              ))}
            </div>
          ) : (
            <p class="text-slate">No upcoming events at this time.</p>
          )}

          <div class="mt-12 p-6 bg-burgundy/10 border border-burgundy/20 rounded-xl">
            <h3 class="font-heading text-lg uppercase tracking-wide text-burgundy mb-2">
              Special Services
            </h3>
            <p class="text-charcoal text-sm">
              During feast days and special occasions, service times may vary. Please check
              this calendar regularly or contact Fr. Philip for the latest schedule.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
